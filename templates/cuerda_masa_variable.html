{% extends "base.html" %}
{% block title %}Cuerda sobre la mesa — Masa variable{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .rope-card-wrap { display:flex; gap:16px; align-items:flex-start; }
  .rope-diagram-card { position:relative; }
  .badge-soft {
    background:#eef2ff; color:#1e2a78; border:1px solid #c7d2fe;
    border-radius:8px; padding:2px 8px; font-size:.8rem;
  }
  .mathmono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }
  .dropdown-header.text-muted { font-size:.8rem; text-transform:uppercase; letter-spacing:.05em; }

  @media (max-width: 768px) {
    .rope-card-wrap { flex-direction:column; align-items:center; }
  }


  .rope-card-wrap {
    display:flex;
    gap:16px;
    align-items:flex-start;
  }

  .rope-diagram-container {
    flex: 0 0 auto;
    display:flex;
    justify-content:center;
    align-items:center;
    width:100%;
  }

  .rope-svg {
    width:100%;
    max-width:320px;   /* súbelo a 360 si la quieres aún más grande */
    height:auto;
  }

  .badge-soft {
    background:#eef2ff; color:#1e2a78; border:1px solid #c7d2fe;
    border-radius:8px; padding:2px 8px; font-size:.8rem;
  }

  .mathmono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }

  @media (max-width: 768px) {
    .rope-card-wrap { flex-direction:column; align-items:center; }
  }


</style>
{% endblock %}

{% block content %}

<div class="row g-4">
  <!-- IZQUIERDA: explicación teórica -->
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Cuerda sobre la mesa (sistema de masa variable)</h5>

        <p class="text-muted small">
          Esta sección conecta el experimento de la <strong>cuerda que cuelga por el borde de una mesa</strong>
          con el <strong>modelo matemático</strong> que viste en clase. La idea es que puedas seguir cada paso:
          configuración física → leyes de Newton → ecuación diferencial → solución analítica.
        </p>

        <hr>

        <!-- Paso 1 -->
        <h6 class="mb-2">1. Configuración física</h6>
        <ul class="small">
          <li>Cuerda homogénea de longitud total \(L\) y masa total \(m\).</li>
          <li>Masa por unidad de longitud: \( \mu = \dfrac{m}{L} \).</li>
          <li>Una parte \(x(t)\) cuelga por el borde; el resto \(L - x(t)\) está sobre la mesa.</li>
          <li>La parte colgante tiene masa \( m_{\text{móvil}}(t) = \mu x(t) \) y cae con velocidad \(v(t)\).</li>
        </ul>

        <!-- Paso 2 -->
        <h6 class="mb-2">2. Fuerza y cantidad de movimiento</h6>
        <p class="small mb-1">
          La fuerza que tira de la cuerda es el peso de la parte colgante:
          \[
            F = m_{\text{móvil}} g = \mu g x.
          \]
        </p>
        <p class="small mb-1">
          Como la masa que se mueve cambia con el tiempo, usamos la forma general:
          \[
            \frac{d}{dt}(m v) = F.
          \]
        </p>
        <p class="small mb-1">
          Con \(m(t) = \mu x(t)\):
          \[
            \frac{d}{dt}(\mu x v) = \mu g x.
          \]
        </p>

        <!-- Paso 3 -->
        <h6 class="mb-2">3. Regla del producto y relación con \(v\)</h6>
        <p class="small mb-1">
          Aplicando la regla del producto:
          \[
            \mu \frac{dx}{dt} v + \mu x \frac{dv}{dt} = \mu g x.
          \]
        </p>
        <p class="small mb-1">
          Como \( \dfrac{dx}{dt} = v \), obtenemos:
          \[
            \mu v^2 + \mu x \frac{dv}{dt} = \mu g x
            \;\Rightarrow\;
            v^2 + x\frac{dv}{dt} = g x.
          \]
        </p>

        <!-- Paso 4 -->
        <h6 class="mb-2">4. Cambio de variable y forma en función de \(x\)</h6>
        <p class="small mb-1">
          Usamos la regla de la cadena:
          \[
            \frac{dv}{dt} = \frac{dv}{dx}\frac{dx}{dt} = v \frac{dv}{dx}.
          \]
        </p>
        <p class="small mb-1">
          Sustituyendo:
          \[
            v^2 + x \left( v \frac{dv}{dx} \right) = g x.
          \]
        </p>
        <p class="small mb-1">
          En uno de los modelos simplificados que se estudian (y el que usamos aquí para comparar con el cuaderno)
          se toma la forma:
          \[
            v \frac{dv}{dx} = \frac{g}{L} x,
          \]
          que es precisamente la ecuación implementada en el notebook.
        </p>

        <!-- Paso 5 -->
        <h6 class="mb-2">5. Integración: solución analítica</h6>
        <p class="small mb-1">
          Partimos de:
          \[
            v \frac{dv}{dx} = \frac{g}{L} x.
          \]
        </p>
        <p class="small mb-1">
          Integramos:
          \[
            \int v\,dv = \frac{g}{L} \int x\,dx
            \;\Rightarrow\;
            \frac{v^2}{2} = \frac{g}{2L}x^2 + C.
          \]
        </p>
        <p class="small mb-1">
          Con la condición inicial \( v(x_0) = v_0 \):
          \[
            C = \frac{v_0^2}{2} - \frac{g}{2L}x_0^2.
          \]
        </p>
        <p class="small mb-1">
          Entonces:
          \[
            v^2 = v_0^2 + \frac{g}{L}(x^2 - x_0^2),
          \]
          y finalmente:
          \[
            \boxed{ v(x) = \sqrt{\,v_0^2 + \tfrac{g}{L}(x^2 - x_0^2)\,} }.
          \]
        </p>

        <hr>
        <p class="small text-muted mb-0">
          Debajo puedes ver un diagrama interactivo de la cuerda:
          mueve \(x\) y observa cómo crece la parte colgante y la velocidad \(v(x)\).
        </p>
      </div>
    </div>
  </div>

  <!-- DERECHA: calculadora + diagrama interactivo -->
  <div class="col-lg-5">
    <div class="card shadow-sm rope-diagram-card">
      <div class="card-body">
        <h5 class="card-title mb-3">Calculadora \(v(x)\) y diagrama de la cuerda</h5>

        <form method="post" class="row gy-3" id="formCuerda">
          <div class="col-6">
            <label class="form-label">Gravedad \(g\) [m/s²]</label>
            <input type="number" step="0.01" class="form-control" name="g" id="gInput" value="{{ g }}">
          </div>

          <div class="col-6">
            <label class="form-label">Longitud total \(L\) [m]</label>
            <input type="number" step="0.01" class="form-control" name="L" id="LInput" value="{{ L }}">
          </div>

          <div class="col-6">
            <label class="form-label">\(x_0\) inicial [m]</label>
            <input type="number" step="0.01" class="form-control" name="x0" id="x0Input" value="{{ x0 }}">
            <div class="form-text small">Longitud colgante al inicio.</div>
          </div>

          <div class="col-6">
            <label class="form-label">Velocidad inicial \(v_0\) [m/s]</label>
            <input type="number" step="0.001" class="form-control" name="v0" id="v0Input" value="{{ v0 }}">
          </div>

          <div class="col-12">
            <label class="form-label">Longitud colgante \(x\) [m]</label>
            <input type="range"
                   min="{{ x0 }}"
                   max="{{ L }}"
                   step="0.01"
                   class="form-range"
                   id="xEvalRange"
                   value="{{ x_eval }}">
            <input type="number"
                   step="0.01"
                   class="form-control mt-2"
                   id="xEvalInput"
                   name="x_eval"
                   value="{{ x_eval }}">
            <div class="form-text small">
              Mueve \(x\): más cuerda colgando ⇒ más masa tirando ⇒ mayor \(v(x)\).
            </div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Calcular con Flask</button>
          </div>
        </form>

        <hr>

        <!-- Resultado servidor -->
        {% if msg_error %}
          <div class="alert alert-warning small mb-2">
            {{ msg_error }}
          </div>
        {% endif %}

        {% if valido and v_eval is not none %}
          <p class="small mb-1 text-muted">Cálculo desde el servidor:</p>
          <p class="fs-6">
            \( v({{ '%.2f'|format(x_eval) }}) =
               \sqrt{v_0^2 + \tfrac{g}{L}({{ '%.2f'|format(x_eval) }}^2 - x_0^2)} 
               \approx {{ '%.4f'|format(v_eval) }}\ \text{m/s} \)
          </p>
        {% endif %}

        <!-- Resultado en vivo -->
        <div class="mt-2">
          <span class="badge-soft">
            x = <span id="xEvalLive" class="mathmono">—</span> m
          </span>
          <span class="badge-soft ms-2">
            v(x) ≈ <span id="vEvalLive" class="mathmono">—</span> m/s
          </span>
        </div>

        <hr>

        <!-- Diagrama interactivo de la cuerda -->
       






<div class="rope-card-wrap mt-2">
  <div class="rope-diagram-container">
    <svg id="ropeSvg"
         viewBox="0 0 260 220"
         class="rope-svg"
         aria-label="Cuerda sobre mesa">
      <!-- Mesa -->
      <rect x="20" y="80" width="220" height="10" fill="#e5e5e5" />
      <!-- Borde de la mesa -->
      <line x1="170" y1="50" x2="170" y2="200" stroke="#999" stroke-width="2" stroke-dasharray="4 3" />
      <text x="175" y="65" font-size="9" fill="#555">Borde</text>

      <!-- Cuerda sobre la mesa -->
      <line id="ropeTable"
            x1="30" y1="85"
            x2="190" y2="85"
            stroke="#c77d1a"
            stroke-width="4"
            stroke-linecap="round" />

      <!-- Cuerda colgante -->
      <line id="ropeHang"
            x1="190" y1="85"
            x2="190" y2="85"
            stroke="#c77d1a"
            stroke-width="4"
            stroke-linecap="round" />

      <!-- Flecha x -->
      <line id="xArrow"
            x1="205" y1="85"
            x2="205" y2="160"
            stroke="#222"
            stroke-width="1.5"
            marker-end="url(#arrowDown)" />
      <text id="xLabel"
            x="210" y="120"
            font-size="10"
            fill="#222">x</text>

      <text x="30" y="75" font-size="9" fill="#555">Parte sobre mesa</text>
      <text x="120" y="200" font-size="9" fill="#555">Parte colgante</text>

      <defs>
        <marker id="arrowDown" markerWidth="8" markerHeight="8"
                refX="3" refY="2.5" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L0,5 L5,2.5 z" fill="#222" />
        </marker>
      </defs>
    </svg>
      
</div>

  </div>


<div class="small text-muted">
    La cuerda naranja muestra la parte sobre la mesa y la parte colgante.
    A medida que \(x\) aumenta, la porción colgante crece y la velocidad \(v(x)\) también.
  </div>


<hr>

<h6 class="mt-3 mb-1">Gráfica de \(v(x)\)</h6>
<p class="small text-muted">
  La curva muestra la solución analítica \(v(x)\).
  El tramo resaltado corresponde a la longitud colgante actual seleccionada con el slider.
</p>
<canvas id="vChart" height="180"></canvas>


      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const gInput   = document.getElementById('gInput');
  const LInput   = document.getElementById('LInput');
  const x0Input  = document.getElementById('x0Input');
  const v0Input  = document.getElementById('v0Input');
  const xRange   = document.getElementById('xEvalRange');
  const xInput   = document.getElementById('xEvalInput');
  const xLive    = document.getElementById('xEvalLive');
  const vLive    = document.getElementById('vEvalLive');

  const ropeTable = document.getElementById('ropeTable');
  const ropeHang  = document.getElementById('ropeHang');
  const xArrow    = document.getElementById('xArrow');
  const xLabel    = document.getElementById('xLabel');

  const vCanvas   = document.getElementById('vChart');

  // ===== Modelo analítico v(x) =====
  function v_of_x(g, L, x0, v0, x) {
    if (!(L > 0)) return null;
    const val = v0*v0 + (g/L)*(x*x - x0*x0);
    if (val < 0) return null;
    return Math.sqrt(val);
  }

  // ===== Dibujo de la cuerda =====
  function drawRope(L, x) {
    if (!ropeTable || !ropeHang) return;
    if (!(L > 0)) return;

    const tableStartX = 30;
    const tableY      = 85;
    const edgeXMax    = 190;
    const maxHangPix  = 110;

    let frac = x / L;
    if (frac < 0) frac = 0;
    if (frac > 1) frac = 1;

    const tableLen = (edgeXMax - tableStartX) * (1 - frac);
    const edgeX    = tableStartX + tableLen;
    const hangLen  = maxHangPix * frac;

    // Cuerda sobre mesa
    ropeTable.setAttribute('x1', tableStartX);
    ropeTable.setAttribute('y1', tableY);
    ropeTable.setAttribute('x2', edgeX);
    ropeTable.setAttribute('y2', tableY);

    // Cuerda colgante
    ropeHang.setAttribute('x1', edgeX);
    ropeHang.setAttribute('y1', tableY);
    ropeHang.setAttribute('x2', edgeX);
    ropeHang.setAttribute('y2', tableY + hangLen);

    // Flecha x
    if (xArrow && xLabel) {
      xArrow.setAttribute('x1', edgeX + 10);
      xArrow.setAttribute('x2', edgeX + 10);
      xArrow.setAttribute('y1', tableY);
      xArrow.setAttribute('y2', tableY + hangLen);
      xLabel.setAttribute('x', edgeX + 15);
      xLabel.setAttribute('y', tableY + hangLen/2);
    }
  }

  // ===== Gráfica v(x) con Chart.js =====
  let vChart = null;
  let vLabels = [];
  let vFull   = [];

  function buildOrUpdateChart(g, L, x0, v0, xCurrent) {
    if (!vCanvas) return;
    const N = 80;

    // Recalculamos la curva completa entre x0 y L
    vLabels = [];
    vFull = [];
    for (let i = 0; i <= N; i++) {
      const xi = x0 + (L - x0) * i / N;
      vLabels.push(xi.toFixed(2));
      vFull.push(v_of_x(g, L, x0, v0, xi));
    }

    // Si aún no existe el gráfico, lo creamos
    if (!vChart) {
      vChart = new Chart(vCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: vLabels,
          datasets: [
            {
              label: 'v(x) analítica',
              data: vFull,
              tension: 0.15,
              pointRadius: 0
            },
            {
              label: 'recorrido hasta x',
              data: [],
              tension: 0.15,
              pointRadius: 0,
              borderWidth: 3
            }
          ]
        },
        options: {
          animation: false,
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'x [m]' } },
            y: { title: { display: true, text: 'v(x) [m/s]' }, beginAtZero: true }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    } else {
      // Actualizamos curva base
      vChart.data.labels = vLabels;
      vChart.data.datasets[0].data = vFull;
    }

    // Actualizamos el tramo resaltado según xCurrent
    const idx = vLabels.findIndex(lbl => parseFloat(lbl) >= xCurrent - 1e-9);
    const partial = vFull.map((val, i) => (i <= idx ? val : null));
    vChart.data.datasets[1].data = partial;

    vChart.update();
  }

  // ===== Sincronización general =====
  function updateAll() {
    const g  = parseFloat(gInput.value)  || 9.8;
    const L  = parseFloat(LInput.value)  || 1.0;
    const x0 = parseFloat(x0Input.value) || 0.1;
    const v0 = parseFloat(v0Input.value) || 0.01;

    let x = parseFloat(xInput.value);
    if (isNaN(x)) x = x0;
    if (x < x0) x = x0;
    if (x > L)  x = L;

    // Sync slider ↔ número
    xInput.value   = x.toFixed(2);
    xRange.min     = x0;
    xRange.max     = L;
    xRange.value   = x.toFixed(2);

    // Badges
    if (xLive) xLive.textContent = x.toFixed(2);
    const v = v_of_x(g, L, x0, v0, x);
    if (vLive) vLive.textContent = (v !== null) ? v.toFixed(4) : '—';

    // Dibujo cuerda
    drawRope(L, x);

    // Gráfica v(x) + tramo hasta x
    if (L > x0) {
      buildOrUpdateChart(g, L, x0, v0, x);
    }

    // Refrescar MathJax si está
    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise();
    }
  }

  // Eventos
  if (xRange && xInput) {
    xRange.addEventListener('input', () => {
      xInput.value = xRange.value;
      updateAll();
    });
    xInput.addEventListener('input', () => {
      xRange.value = xInput.value;
      updateAll();
    });
  }

  [gInput, LInput, x0Input, v0Input].forEach(el => {
    if (el) el.addEventListener('input', updateAll);
  });

  // Init
  updateAll();
});
</script>

{% endblock %}
