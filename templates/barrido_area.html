{% extends "base.html" %}
{% block title %}Barrido del área de salida — Interactivo (versión clase){% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .code-wrap{background:#0b1020;color:#e5e7eb;border-radius:10px;padding:1rem 1.25rem;border:1px solid #111827;overflow-x:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;line-height:1.45;position:relative}
  .tt{cursor:help;text-decoration:underline dotted;border-bottom:1px dotted #60a5fa;color:#93c5fd}
  .tt:hover{color:#bfdbfe}
  .param-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .param-grid .full{grid-column:1/-1}
  .copy-btn{position:absolute;top:8px;right:8px;font-size:.85rem;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:6px;padding:.25rem .5rem}
  .legend-pill{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .5rem;border-radius:9999px;border:1px solid #e5e7eb;background:#f8fafc;font-size:.85rem}
  .dot{width:.7rem;height:.7rem;border-radius:50%;display:inline-block}
  .table-sm td,.table-sm th{padding:.35rem .5rem}
  .swatch{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:.4rem}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- Tooltips + LaTeX ----------
  const initTooltips = () => {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
      new bootstrap.Tooltip(el,{html:true,trigger:'hover focus',sanitize:false,container:'body',delay:{show:250,hide:100}});
      el.addEventListener('shown.bs.tooltip',()=>{
        const id=el.getAttribute('aria-describedby'); const tip=id&&document.getElementById(id);
        if(tip && window.MathJax?.typesetPromise){ const inner=tip.querySelector('.tooltip-inner'); if(inner) MathJax.typesetPromise([inner]).catch(()=>{}); }
      });
    });
  };

  // ---------- Inputs ----------
  const AEl  = document.getElementById('paramA');
  const gEl  = document.getElementById('paramg');
  const h0El = document.getElementById('paramh0');
  const pasoEl = document.getElementById('paramPaso');       // paso en altura para integrar
  const k0El   = document.getElementById('paramK0');         // k inicial (tal como en tu código)
  const dKEl   = document.getElementById('paramdK');         // incremento de k
  const nEl    = document.getElementById('paramNcurves');    // número de curvas
  const tvacTblBody = document.getElementById('tbodyCurves');

  // ---------- Misma integración de clase (dt/dh) ----------
  function integrand(A,a,g,h){
    if(h<=0) return 0;
    const beta = Math.max(0, 1 - (a*a)/(A*A));  // evita raíz negativa
    return - (A/a) * Math.sqrt( beta / (2*g*h) );
  }

  function quadSimpson(f, a, b, tol=1e-8, maxDepth=12){
    const sgn = b>=a ? 1 : -1;
    const A = Math.min(a,b), B = Math.max(a,b);
    function S(f, x0, x2){ const x1=0.5*(x0+x2); return (x2-x0)*(f(x0)+4*f(x1)+f(x2))/6; }
    function adapt(f, x0, x2, S0, depth){
      const x1=0.5*(x0+x2), Sleft=S(f,x0,x1), Sright=S(f,x1,x2);
      const err = Math.abs(Sleft+Sright - S0);
      if(err < 15*tol || depth<=0) return Sleft+Sright + (Sleft+Sright - S0)/15;
      return adapt(f,x0,x1,Sleft,depth-1) + adapt(f,x1,x2,Sright,depth-1);
    }
    const S0=S(f,A,B);
    return sgn*adapt(f,A,B,S0,maxDepth);
  }

  function serieNumerica(h0, paso, A, a, g){
    const N = Math.max(1, Math.floor(h0/Math.max(paso,1e-12)));
    const t_num=[], y_num=[];
    let y=Math.max(0,h0);
    for(let i=1;i<=N;i++){
      const value = quadSimpson(h=>integrand(A,a,g,h), h0, y);
      t_num.push(value);
      y_num.push(y);
      y = Math.max(0, y - paso);
    }
    const t0 = t_num[0] || 0;
    const tShift = t_num.map(v=>v - t0);
    return {t:tShift, y:y_num};
  }

  // ---------- Gráfico ----------
  const ctx=document.getElementById('chart').getContext('2d');
  let chart;

  function randomColor(i){
    // paleta fija agradable (10 tonos). Repite si hay más.
    const cols=['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f97316','#e11d48','#22c55e'];
    return cols[i % cols.length];
  }

  function estimateTvacNum(series){
    let tVac = series.t[series.t.length-1];
    if(series.y.length>=2){
      const h1=series.y[series.y.length-2], h2=series.y[series.y.length-1];
      const t1=series.t[series.t.length-2], t2=series.t[series.t.length-1];
      if(h1>0 && h2>=0 && h1!==h2){
        const frac = h1/(h1-h2);
        tVac = t1 + frac*(t2-t1);
      }
    }
    return tVac;
  }

  function update(){
    const A = Math.max(1e-12, parseFloat(AEl.value));
    const g = Math.max(1e-12, parseFloat(gEl.value));
    const h0 = Math.max(0, parseFloat(h0El.value));
    const paso = Math.max(1e-6, Math.min(parseFloat(pasoEl.value), h0));
    let k = Math.max(0, parseFloat(k0El.value));
    const dk = Math.max(0, parseFloat(dKEl.value));
    const nCurves = Math.max(1, parseInt(nEl.value || '1', 10));

    const datasets = [];
    const rows = [];

    for(let i=0;i<nCurves;i++){
      const a = A * k;                          // a = A * k  (exactamente como tu bucle)
      const serie = serieNumerica(h0, paso, A, a, g);
      const color = randomColor(i);
      datasets.push({
        label: `a = A·${k.toFixed(4)}`,
        data: serie.t.map((ti,idx)=>({x:ti, y:serie.y[idx]})),
        parsing:false,
        borderColor: color,
        backgroundColor: color,
        borderWidth: 2,
        fill:false,
        pointRadius: 0,
        tension: 0.08
      });

      const tVac = estimateTvacNum(serie);
      rows.push({i:i+1, k, a, tVac, color});
      k += dk;
    }

    // tabla
    tvacTblBody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="text-muted">${r.i}</td>
        <td><span class="swatch" style="background:${r.color}"></span>a = A·${r.k.toFixed(4)}</td>
        <td>${r.a.toExponential(4)} m²</td>
        <td>${r.tVac.toFixed(4)} s</td>
      `;
      tvacTblBody.appendChild(tr);
    });

    if(!chart){
      chart = new Chart(ctx,{
        type:'line',
        data:{datasets},
        options:{
          parsing:false, animation:{duration:0}, responsive:true,
          interaction:{intersect:false,mode:'nearest'},
          scales:{
            x:{type:'linear', title:{display:true,text:'t (s)'}},
            y:{title:{display:true,text:'h (m)'}, suggestedMin:0, suggestedMax:Math.max(1,h0)}
          },
          plugins:{legend:{display:true, position:'bottom'}}
        }
      });
    }else{
      chart.data.datasets = datasets;
      chart.options.scales.y.suggestedMax = Math.max(1,h0);
      chart.update();
    }

    // refresca snippet (números)
    renderCode(A,g,h0,paso, parseFloat(k0El.value), dk, nCurves);
  }

  // ---------- Código EXACTO de clase (barrido) con tooltips ----------
  const codeEl=document.getElementById('code-block');
  function renderCode(A,g,h0,paso,k0,dk,nCurves){
    const codeHtml = `
import numpy as <b>np</b>
import matplotlib.pyplot as <b>plt</b>
<span class="tt" data-bs-toggle="tooltip" data-bs-title="Bucle que repite la integración para distintas áreas de salida \\(a=A\\,k\\)">
# Variación del área de salida</span>
k = <b>${k0.toFixed(4)}</b>
for i in range(1, <b>${nCurves}</b>):
    <span class="tt" data-bs-toggle="tooltip" data-bs-title="Se usan las funciones de clase: t = h_num(h_0, paso, A, a)[0], y = h_num(...)[1]">
    t = h_num(h_0, <b>${paso}</b>, A, A * k)[0]
    y = h_num(h_0, <b>${paso}</b>, A, A * k)[1]</span>
    plt.plot(t, y)
    <span class="tt" data-bs-toggle="tooltip" data-bs-title="Límites como en clase para comparar tiempos">
    plt.xlim(0, 900)
    plt.ylim(0, 1)</span>
    k = k + <b>${dk.toFixed(4)}</b>
plt.show()`;
    codeEl.textContent=''; codeEl.innerHTML=codeHtml;
    setTimeout(()=>{ initTooltips(); window.MathJax?.typesetPromise?.([codeEl]).catch(()=>{}); },100);
  }

  // ---------- Eventos ----------
  document.getElementById('copy').addEventListener('click',()=>{
    const tmp=document.createElement('textarea'); tmp.value=codeEl.innerText;
    document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
    const btn=document.getElementById('copy'); btn.textContent='¡Copiado!'; setTimeout(()=>btn.textContent='Copiar código',1200);
  });

  document.getElementById('reset').addEventListener('click',()=>{
    AEl.value=2.0; gEl.value=9.8; h0El.value=1.0; pasoEl.value=0.001;
    k0El.value=0.0005; dKEl.value=0.0001; nEl.value=10;
    update();
  });

  [AEl,gEl,h0El,pasoEl,k0El,dKEl,nEl].forEach(el=>{
    el.addEventListener('input',update);
    el.addEventListener('change',update);
  });

  const modal=document.getElementById('explicacionModal');
  modal?.addEventListener('shown.bs.modal',()=>{ window.MathJax?.typesetPromise?.([modal]).catch(()=>{}); });

  // init
  initTooltips();
  document.getElementById('reset').click();
});
</script>
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="h3 mb-2">Barrido del área de salida \(a=A\,k\)</h1>
  <p class="text-muted mb-3">
    Repetimos el cálculo numérico de clase para varios valores de \(a\) dados por \(a=A\,k\) (<em>k</em> inicial, incremento y número de curvas),
    y comparamos cómo cambia la curva \(h(t)\) y el tiempo de vaciado estimado.
  </p>

  <div class="row g-3 align-items-stretch mb-4">
    <div class="col-lg-4">
      <div class="card h-100"><div class="card-body">
        <h6 class="text-secondary mb-3">Parámetros</h6>
        <div class="param-grid">
          <div><label class="form-label">A (m²)</label><input type="number" step="any" class="form-control" id="paramA" value="2.0"></div>
          <div><label class="form-label">g (m/s²)</label><input type="number" step="any" class="form-control" id="paramg" value="9.8"></div>
          <div><label class="form-label">h₀ (m)</label><input type="number" step="any" class="form-control" id="paramh0" value="1.0"></div>
          <div class="full">
            <label class="form-label">paso (m) — altura para la integral</label>
            <input type="number" step="any" class="form-control" id="paramPaso" value="0.001">
          </div>

          <div><label class="form-label">k inicial</label><input type="number" step="any" class="form-control" id="paramK0" value="0.0005"></div>
          <div><label class="form-label">Δk (incremento)</label><input type="number" step="any" class="form-control" id="paramdK" value="0.0001"></div>
          <div class="full">
            <label class="form-label">n° de curvas</label>
            <input type="number" step="1" min="1" class="form-control" id="paramNcurves" value="10">
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-secondary btn-sm" id="reset" type="button">Restablecer</button>
          <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#explicacionModal">
            Ver explicación
          </button>
        </div>
      </div></div>
    </div>

    <div class="col-lg-8">
      <div class="card h-100"><div class="card-body">
        <h6 class="text-secondary mb-2">Curvas \(h(t)\) para distintos \(a=A\,k\)</h6>
        <canvas id="chart" height="140"></canvas>
      </div></div>
    </div>
  </div>

  <!-- Tabla resumen de cada curva -->
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="text-secondary mb-2">Resumen por curva</h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Etiqueta</th>
              <th>a (m²)</th>
              <th>t<sub>vac</sub> (num, s)</th>
            </tr>
          </thead>
          <tbody id="tbodyCurves"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Código de clase con tooltips -->
  <div class="code-wrap mb-4">
    <button class="copy-btn" id="copy" type="button">Copiar código</button>
    <pre class="code"><code id="code-block"></code></pre>
  </div>
</div>

<!-- ===== Modal de explicación ===== -->
<div class="modal fade" id="explicacionModal" tabindex="-1" aria-labelledby="explicacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="explicacionLabel">Qué hace el barrido del área y qué se observa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ol class="mb-3">
          <li><strong>Definición:</strong> fijamos \(A,g,h_0\) y variamos el área de salida como \(a=A\,k\), con
            \(k=k_0,k_0+\Delta k,\dots\) (tantas curvas como indiques).</li>
          <li><strong>Cálculo por curva:</strong> para cada \(a\) ejecutamos <code>h_num(h_0, paso, A, a)</code> (idéntico al de clase),
            obtenemos \((t_\text{num},h)\) y estimamos \(t_\text{vac}\) por interpolación de los dos últimos puntos.</li>
          <li><strong>Efecto físico:</strong> al aumentar \(a\) (o \(k\)) el vaciado es más rápido:
            la curva \(h(t)\) cae más empinada y \(t_\text{vac}\) disminuye.</li>
        </ol>
        <div class="alert alert-secondary small">
          <strong>Notas numéricas:</strong> se usa el mismo integrando \( \dfrac{dt}{dh} \) con el factor \( \sqrt{1-a^2/A^2} \)
          y se evita tomar raíces de negativos. El paso en altura controla cuántos puntos se calculan por curva.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
